# 依存性逆転の原則について

## 安定依存の原則と並べての考察

DIPはクラス設計の原則でSDPはパッケージ設計の原則とされ、元々は微妙にスコープの違う話となる。

パッケージとはおそらくJava言語の考え方をベースにしていると思われ（Javaは詳しくないが…）再利用可能な単位のクラスの集合を指していると思われ、言語によっては名前空間やモジュールといった単位で区切られたまとまりのことであると考えられる。

SDPは「安定度の高い（変更の発生しにくい）方向に依存せよ」というもの。
DIPは「上位レイヤーは下位レイヤーに依存すべきでない」というもの。

安定度・抽象度等価の原則（SAP）に言われるように、安定度の高い（変更しにくい、依存されている）パッケージは抽象度が高くあるべきで、不安定なパッケージは具体的で抽象度が低くあるべきとされる。

## クリーンアーキテクチャの設計への疑問と原則の意味

しかし抽象度の高いパッケージがより安定しているとするなら、オニオンアーキテクチャやクリーンアーキテクチャの文脈だとApplicatonが一番抽象度が高くて安定している気がするけど、具体性の高いPresentationに上位レイヤーとして依存してしまいそうな気がする。
そもそもパッケージの考え方はインターフェイスを外部に公開した上でコンパイルしてパッケージ単位でそれを扱えるようにする、という前提があるように思う。

他の原則シリーズにも言えることだが、本質的には「より安定して変更の少ないものに依存せよ」というものをケースによって言い換えているだけに思える。不安定モジュールや不安定クラスへの依存がある場合は逆転させるのが良いが、そうでないならば特に逆転させる必要はないと思われる。

## DIPは原則ではなく手法である

DIPの原文は以下とされる

> High-level modules should not import anything from low-level modules. Both should depend on abstractions (e.g., interfaces).
> Abstractions should not depend on details. Details (concrete implementations) should depend on abstractions.

高レベルモジュールは低レベルモジュールをインポート（依存）すべきではない。また詳細に依存すべきではなく、抽象に依存すべきである。

> The principle of dependency inversion is at the root of many of the benefits claimed for object-oriented technology. Its proper application is necessary for the creation of reusable frameworks. It is also critically important for the construction of code that is resilient to

DIPはオブジェクト指向がもたらす多くのメリットの根底にある。再利用性のあるフレームワーク作成にはDIPの適切な適用が必要であり、非常に重要である。

原則という言葉に惑わされがちだが、DIPは「適用するもの」であることからも、ルールというよりは公式や手法の類だと捉えるのが適切と思われる。

## DIPのメリットと使いどころ

DIPは再利用性を意識したライブラリ作成時などに特に重要と思われるが、逆説的に再利用しない1点物のアプリケーションを作成する場合にはさして重要ではないとも言える。

DIPの主要なメリットはやはりインターフェイスを満たしたクラスを複数作成し、これを差し替えるような場面において有効というものである。
当然ながら1インターフェイスに対して1クラスしか実装しないような小規模アプリケーションにおいてはメリットが著しく低いと言えるだろう。このようなケースにおいてはDIPは後からの適用も容易であり、必要になったタイミングでリファクタリングを実施すれば良いだけのことでもある。

あらゆるコードを書くときには1行毎にその意味を考えるが、特に個人で作成するような小規模アプリケーションにおいてDIPにはその意味が薄い。小さいアプリケーションではそもそも恩恵を受けられない。あるとしても遠い将来の可能性に対する投資だが、それはそもそもYAGNIに反する考え方である。

他に考えられるメリットとしては依存性低減による単体テストの書きやすさといったものだが、これは言語によるし、そもそも単体テストに対する信頼度が高くなければ意味は薄れる。
モックをファイルごとにインポート単位で適用できるPythonなどではそもそもテストの書きやすさ向上という観点でのメリットすら著しく低いと思われる。

例えば、インターフェイスに2クラス以上を実装することのないような小規模なアプリケーションで、単体テストの信頼度がそもそも低いようなプロダクトにおいては、

## 結論

DIPは大規模なアプリケーションの一部や、再利用性を強く意識する必要のあるモジュール等を作成する場合には有用なケースもあると思われるが、小規模なアプリケーションの開発には向かない。
必ず全てのコードに適用する必要のあるような類の原則でもない。