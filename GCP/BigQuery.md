# BigQuery

フルマネージド列指向フルスキャンデータベース。  
結果量ではなくスキャン量に応じて課金される。  
Google様のマシンパワーで並列処理し、インデックス定義とかはせず必ずフルスキャンする。  
実質、無限行を格納できるDB。


## 料金

2種類の課金要素がある。

- 格納しているデータ量に応じてかかる
- クエリに応じてかかる


## 節約ノウハウ

列指向なので、列を限定してSELECTすることで料金を抑えられる。  
テーブル単位で毎回必ずフルスキャンされるので、テーブルを分けるのが定石。  
例えば、ログを格納する場合は日付をテーブル名に入れるなど。  
同じクエリを何度も投げる場合はキャッシュが効くケースもある（NOWとか入ってるとダメ）

直近7日までのデータに限定してSELECTする機能がある。

## データセットとは

テーブルとビューへのアクセスを整理して制御するために使用されるトップレベルコンテナの概念。

### 制約

- 地理的なロケーションは作成時にのみ設定でき、一度作成すると変更不可。
- 1つのクエリで参照されるすべてのテーブルは、同じロケーションにあるデータセット内に保存されている必要がある。
- データセット名はプロジェクトごとに一意
- テーブルをコピーする場合、先と元が同一ロケーションである必要がある。

### 課金

データセットの作成・更新・削除については課金されない。

## BigQueryジョブとは

データの

- 読み込み
- エクスポート
- クエリ
- コピー

といったものを、BigQueryがユーザーに代わって実行するアクションのこと。

ジョブの実行には長時間を要する場合があるため、非同期で実行され、ステータスをポーリングできる。



## テーブルの概要

すべてのテーブルは、列名、データ型、その他の情報を記述するスキーマによって定義される。  
スキーマはテーブル作成時に指定できる。  
あるいは、スキーマなしでテーブルを作成し、クエリジョブまたは読み込みジョブでスキーマを宣言してデータを取り込むこともできる。

テーブルタイプが存在し、以下のタイプがサポートされている。

- ネイティブテーブル
- 外部テーブル（BigQuery外部にあるストレージでサポートされるテーブル）
- ビュー（SQLクエリによって定義される仮想テーブル）


## 分割テーブルの概要

パーティションと呼ばれるセグメントに分割された特殊なテーブルで、通常よりデータの管理や紹介を簡単に行うことができる。  
大きいテーブルを分割することでクエリのパフォーマンスを向上させ、読み取られるバイト数を減らすことができる。

分割は以下2種類のどちらかの時間に対して行われる。

- 取り込み時間
- 特定のTIMESTAMP列、またはDATE列

## クラスタ化テーブルの概要

RDBにおけるインデックスのような概念に近い。

テーブル内のスキーマ内の1個以上の列の内容に基づいてテーブルのデータが自動的に編成される。  
指定した列は、関連するデータを同じ場所に配置するために使用される。  
複数の列を指定する場合は、順序が重要になる。

クラスタリング列に基づいてデータをフィルタする句を含むクエリを送信すると、BigQueryは並び替えられたブロックを使用して不要なデータのスキャンを省略する。

分割テーブルと併用した場合、分割テーブルで切られたパーティションが作られ、その中でブロック化される。
