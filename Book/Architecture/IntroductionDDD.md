# ドメイン駆動設計入門

エリック・エヴァンスのDDD本はあまりに難解な文章で書かれており、代わりにDDD理解のため手にとった本。
筋道立てて読者に解説することを意識している本だと感じた。
基本的にDDDはオブジェクト指向を少し具体化して名前を与えた概念のように感じた。
ただDIなど明示されていない概念を各所で使用しているように思う。軽くそうした概念の名前について触れておいて貰えると追加で検索して知識を深めやすそうだと感じた。

## ドメインの概念

基本的なドメインの概念を表現する手段は３つ

1. 値オブジェクト
2. エンティティ
3. ドメインサービス

ドメインの概念を用いて組み立てられるもの

1. ユースケース

## ドメインモデルとは

> ドメインは「領域」の意味を持った言葉

## 値オブジェクト

システム固有の値を表現することを目的としたオブジェクト(クラス)のこと。
オブジェクト指向的な側面もある。

文字列リテラルのような「値」は不変であり「値オブジェクト」はそれに類する概念であり、一般的な「オブジェクト」と違う。

値は代入（交換）によってのみ変更を表現可能である。
値は等価性によって比較される。

値オブジェクトは値であるため、`1 == 1`と同じように`a == b`というように比較可能であるべき。
`a.value == b.value`ではいけない。

値オブジェクトにすべきかどうかの一つ判断基準は
1. そこにルールが存在しているか
2. それ単体で取り扱いたいか

## エンティティ

固有の同一性（identity）で識別するオブジェクト（クラス）のこと

エンティティはライフサイクルを持つ点で値オブジェクトと異なる。
基本的にプロパティの値は可変だが、不変にできるならその方が可読性は上がる。

## サービス

> ソフトウェア開発の文脈で語られるサービスはクライアントのために何かを行うオブジェクト

DDDの文脈ではドメインサービスとアプリケーションサービスがある。

### ドメインサービス

値オブジェクトやエンティティに記述すると不自然になってしまう「ふるまい」をドメインサービスに記述して解決する。
複数のドメインオブジェクトを横断するような操作によく見られる。

ドメインサービスに書きすぎてドメインモデル貧血症にならないように注意が必要。

ドメインサービスは値オブジェクトやエンティティと組み合わせて利用される。

ドメインサービスの関心事は値オブジェクトやエンティティと同一の括りであり、本来データストアは存在しない。
入出力を伴う処理を取り扱わないようにするべきという考えもある。

入出力操作はアプリケーションの関心事であり、ドメインの概念や知識のコード上の表現であるドメインオブジェクトがデータストア操作をすることは望ましくない。

#### ドメインサービスの命名

命名規則としては以下３種のどれかになるケースが多い

- ドメインの概念
  - シンプルだがコーディング時に意識が必要になる
- ドメインの概念 + Service
  - e.g. XxxDomain.Services.XxxService
- ドメインの概念 + DomainService
  - 冗長だが勘違い防止には最強

### アプリケーションサービス

ドメインオブジェクト3種を協調させてユースケースを実現するオブジェクト。

アプリケーションサービスはドメインモデルを扱うが、戻り値としてドメインオブジェクトを渡すのは将来的に大きな危険が伴う。

これを解決する手段としてDTO（DataTransferObject）がある。ドメインオブジェクトをDTOに変換する処理はアプリケーションサービスが担う。

## リポジトリ

一般的なリポジトリという言葉の意味は「保管庫」
データにまつわる処理を分離し、ソフトウェアの柔軟性に寄与するパターン。

データの永続化と再構築を抽象的に扱うためのオブジェクト。
具体的なSQLなどはここに記述して良い。
オブジェクトをデータストアに保存する際には、直接ではなくリポジトリに依頼する。

リポジトリはドメインの概念を由来とするものではないが、ドメインと無関係でもない。
リポジトリの存在がドメインオブジェクトを際立たせる。

リポジトリはインターフェース（抽象）で定義される。（本体となるリポジトリも定義する）
DIの概念が含まれていそう。

### インターフェースについて

テストを記述する際などに抽象化されているとダミーのリポジトリを注入しやすい。

