# GoogleCloudPlatform エンタープライズ設計ガイド

## クラウド利用についてと、GCPのメリデメ

最初は概論

### クラウドの3世代

- 第一世代：サーバー、ストレージ、ネットワークリソースを仮想化したプライベートクラウド
- 第二世代：データセンター自体を仮想化したパブリッククラウド
- 第三世代：ITインフラそのものを仮想化したサービス

### 日本企業がパブリッククラウドを利用する際に重視する項目

- 国内リージョン
- 仮想プライベートネットワーク環境
- 自社拠点と仮想プライベートネットワーク環境を接続するセキュアな回線
- 仮想プライベートネットワーク環境内で利用可能なIaaS

### 可用性

> 「Googleサービスを使おうと思って使えなかったことはありますか？」

### GCPのデメリット

日本語のサポートは平日9〜17時に限定されており、これ以外は英語でのサポートになる。  

## コンピューティングサービス

4種類ある。

### Google Compute Engine

GCEとも呼ばれる。  
開発者自身がサーバーに必要なスペックやOSを選定するIaaS（Infrastracture as a Service）


### Google App Engine

GAEとも呼ばれる。  
スケーラブルなWebアプリケーションを構築するためのPaaS（Platform as a Service）

Standard Edition（SE）とFlexible Edition（FE）がある。
まずSEを検討し、機能面で問題があればFEを検討すべき。


以下の魅力的な点を備えている。
- オートスケール
- フルマネージド（NoOps）
- Blue-Greenデプロイ
- Cloud Security Scannerを使うことで、アプリケーションの脆弱性をスキャンし、脅威を検出して攻撃を未然に防ぐことができる。


### Google Kubernetes Engine

GKEとも呼ばれる。  
Dockerコンテナの実行環境が提供される。

プライベートな環境としてGoogle Container RegistryにDockerイメージを保存して使用できる。

### Google Cloud Functions

クラウド場で関数を呼び出した時のみプロセスが起動し、処理が終われば停止する、イベントドリブンのサービス。  
コード実行時間に対してのみ、100ms単位で課金される。

本書執筆時点ではベータ版。

## ストレージサービス

5種類ある。BigQueryはビッグデータサービスとして別枠で扱う。

|サービス |分類 |概要 |用途 |
|-------|-----|----|----|
| Google Cloud Storage(GCS) | BLOB | オブジェクトストレージ | 画像、写真、動画、非構造化データ、バックアップ |
| Google Cloud Bigtable | NoSQL | ワイドカラム型DB | 低レイテンシーアクセス、高スループット解析 |
| Google Cloud Datastore | NoSQL | ドキュメント指向DB | Key-Valueデータ、オートスケーリング |
| Google Cloud SQL | RDB | RDBサービス | 構造化データ、OLTPトランザクション |
| Google Cloud Spanner | RDB | グローバルで水平スケーリング機能を備えたRDBサービス | 高トランザクション（OLTP）、高い拡張性要件、グローバルトランザクション |

### CloudStorage

ファイルの静的配信やバックアップなどが主な用途。
オブジェクトストレージ。

### Bigtable

業界標準となっているApache HBase APIを通じてアクセス可能なフルマネージドNoSQLサービス。  
大規模、低レイテンシー、高スループットが求められる用途で活躍する。

### Datastore

サービス規模に合わせて自動的にスケールされ、処理速度が変化しないことが最大の特徴。  
強整合性と結果整合性の好きな方を選んで更新処理を行える。

### CloudSQL

MySQLとPostgreSQLが選択可能。  
大規模分散アーキテクチャを指向するGoogleはこれまであまり重視していなかったようだが、昨今は拡張が推進されているように見える。

### Spanner

従来のRDBとNoSQLの**いいとこどり**を実現したRDBサービスである。

## ネットワーキングサービス

５種類ある。

### Virtual Private Cloud(VPC)

GCPリソースのために論理的に分離された仮想ネットワーク

### Cloud Load Balancing

グローバルな負荷分散を行うレイヤー4の負荷分散サービス

### Cloud CDN

キャッシュサービス

### Cloud DNS

低レイテンシーで高品質なDNSサービス

### Cloud Interconnect

自社オンプレ環境からセキュアにネットワーク接続するサービス

## ビッグデータサービス

５種類ある。

| サービス | 概要 | 用途 | コメント |
|---------|-----|------|--------|
| Cloud Pub/Sub | 多対多の非同期メッセージングサービス | ストリーミングデータ取り込み | 1対多の複数形だったような |
| BigQuery | フルマネージドデータウェアハウス | データレイク、インタラクティブなクエリ分析 | データ蓄積〜処理分析 |
| Cloud Dataflow | バッチ/オンラインのデータパイプライン | ETL処理 | データ処理分析 |
| Cloud Dataproc | Apache Hadoop/Apache Sparkのマネージドサービス | 大規模分散処理 | データ蓄積〜処理分析 |
| Cloud Datalab | データ分析、可視化、機械学習のためのインタラクティブ分析ツール | インタラクティブなデータ分析、機械学習モデル構築 | データ探索/可視化 |

### Cloud Pub/Sub

アプリケーションを構成するコンポーネントを疎結合で繋ぐ役割。
世界中の複数のデータセンター内で稼働している。

Publisher → Topic → Subscription → Subscriber

### BigQuery

データウェアハウスの定義は広いが、その代表格。

### Cloud Dataflow

「Cloud Dataflow プログラムの実行」と「パイプラインの実行」の２フェーズがある。

前者はパイプラインと呼ばれる一連の処理フローを設計し、実行するための環境を構築する事前準備のこと。  
後者は構築したパイプラインに実際にデータを渡し変換処理からデータ格納を行うこと。これは「Cloud Dataflow ジョブ」という単位で実行される。

### Cloud Dataproc

自前でやるよりも早く、簡単に、安く Hadoop / Spark クラスタを構築できる、フルマネージドサービス。

### Cloud Datalab

対話型で利用できるデータ分析および機械学習ツール。

コンテナをGCE上で実行する仕組み。  
PythonまたはSQLコードとコードの実行結果をノートブックという単位で管理する。


## 機械学習サービス

大きく２種類に分けられる。
「学習済みモデルを利用できる」サービスと「利用者独自の機械学習モデル作成を助ける」サービスである。

### 学習済みAPI

| 分類 | サービス | 機能 |
|-----|---------|-----|
| 言語処理 | Cloud Natural Language API | テキストデータを構造と意味を解析する |
| 言語処理 | Cloud Translation API | テキストデータを異なる言語に翻訳する |
| 音声処理 | Cloud Speech API | 音声をテキストデータに変換する |
| 視覚処理 | Cloud Vision API | 画像データを解析して情報の抽出や分類を行う |
| 視覚処理 | Cloud Video Inteligenc API | メディアコンテンツ（動画）を解析し検索する |
| その他 | Cloud Jobs API | 求職者が適職を探すことを支援する |

### 独自モデル作成支援

| サービス | 機能 |
|---------|-----|
| Cloud Machine Learning Engine | 独自の機械学習モデルを作成するための環境やツールをトータルで提供するマネージドサービス。TensorFlowを使った機械学習プログラムの学習、実行環境 |
| Cloud Auto ML | 機械学習の専門知識がなくても独自の機械学習モデルを作成できるサービス |

## アカウント管理・請求管理

GCPプロジェクトは、以下３要素で構成される。

- プロジェクト名
- プロジェクトID（グローバルに一意）
- プロジェクト番号（Google側で自動付与）

GCPプロジェクトに対して、請求先アカウントを紐づける。

### 請求管理

予算作成と、それに対するアラートの機能、課金データのエクスポート機能がある。

利用額が一定の額（50%、100%など）を超過した場合にアラートメールを送ることができるが、上限に達しても利用を強制的に停止はしないため、想定外の請求を回避することはできない。あくまで目安として使うものとなる。

### Cloud IAM

ホワイトリスト形式で、アカウントに対してクラウド上のリソースを操作するための権限を制御できる。

#### アカウント

- Googleアカウント（gmail.comアドレスなど）
- サービスアカウント（アプリケーションアカウント）
- Googleグループ（Googleアカウントやサービスアカウントをまとめて管理するもの）
- G Suiteドメイン
- Cloud Identityドメイン

#### アクセス制御（役割、Role）

'<service>.<resource>.<verb>'
で指定する

例：'compute.machineTypes.list'

- Private roles
  - 管理者（オーナー）
  - 編集者（エディター）
  - 閲覧者（ビューワー）
- Predefined roles（GCPの個々のリソースレベルで付与するRole）
- Custom roles

基本的にはPredefined rolesでよく、より厳密な管理が必要な場合にCustom rolesを使う。

#### 監査証跡

GCPでは捜査ログをCloud Audit Loggingで取得し、確認することができる。

プロジェクトごとに「管理アクティビティ」と「データアクセス」という2種類の監査ログが取得される。
BigQuery以外のサービスでは「データアクセス」ログはデフォルト無効になっている。（膨大なサイズになる可能性があるため）

## 運用監視サービス

基本的にはGCPサービスに対して利用可能だが、有料プランでAWSなど外部サービスの監視も可能。

| サービス | 概要 | 大分類 | 概要 |
|---------|-----|-------|----|
| Stackdriver Monitoring | メトリクス監視、イベント情報の収集、ダッシュボード、アラート通知 | 運用監視 | 監視情報のダッシュボード上での可視化、アラート |
| Stackdriver Logging | API操作、ミドルウェア、アプリケーションログ表示、フィルタリング | 運用監視 | ログの閲覧、フィルタ、アラート |
| Stackdriver Error Reporting | アプリケーションエラー分析、集計、通知サービス、アラート通知 | 開発サイクル効率化 | エラーの集計・表示 |
| Stackdriver Trace | レイテンシーのサンプリング、URLごとの統計情報とレイテンシー分析のレポート | 開発サイクル効率化 | ボトルネック判断用 |
| Stackdriver Debugger | 稼働中の本番環境コードに対して直接デバッグ | 開発サイクル効率化 | 稼働中サービスで特定行のスタックや変数をキャプチャ |

## 機械学習サービス

1. まず利用したいAPIを有効化する
1. クライアントライブラリをダウンロード・利用する

で手軽に使用できる。

- Cloud ML(Machine Learning) Engine
- Cloud Speech API
- Cloud Vision API
- Cloud Translate API
- Cloud Natural Language API
- Cloud Video Intelligence API
